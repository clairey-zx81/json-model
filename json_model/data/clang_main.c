#ifdef WITH_MAIN
#include <stdio.h>
#include <unistd.h>

int main(int argc, char* argv[])
{
    CHECK_FUNCTION_NAME_init();

    // get options
    int opt;
    char* name = "";
    while ((opt = getopt(argc, argv, "hln:")) != -1)
    {
        switch (opt) {
            case 'n':
                name = optarg;
                break;
            case 'h':
                fprintf(stdout,
                        "Usage: %s [-h] [-n name] [files...]\n"
                        "Check JSON values validity against a JSON model\n"
                        "Generated by jmc (JSON Model Compiler) version %s\n"
                        "see https://github.com/clairey-zx81/json-model\n",
                        argv[0], JSON_MODEL_VERSION);
                return 0;
            case 'l':
                fprintf(stdout, "JSON Model names (empty for default):");
                for (int i = 0; i < array_length(_check_model_map); i++)
                    fprintf(stdout, "%s ", _check_model_map[i].name);
                fprintf(stdout, "\n");
                return 0;
            case '?':
                fprintf(stdout, "unexpected option: %c\n", opt);
                return 1;
        }
    }

    // get checker function
    const check_fun_t checker = CHECK_FUNCTION_NAME_fun(name);
    if (checker == NULL)
    {
        fprintf(stderr, "check function not found\n");
        return 2;
    }

    int errors = 0;

    for (int i = optind; i < argc; i++)
    {
        json_error_t error;

        // read and parse JSON file
        json_t* value = json_load_file(argv[i], JSON_DECODE_ANY|JSON_ALLOW_NUL, &error);
        if (value == NULL)
        {
            errors++;
            fprintf(stdout, "%s: ERROR (%s at %d:%d)\n",
                    argv[i], error.text, error.line, error.column);
            continue;
        }

        // check value against model, fast (no path nor reasons)
        if (checker(value, NULL, NULL))
            fprintf(stdout, "%s: PASS\n", argv[i]);
        else
            fprintf(stdout, "%s: FAIL\n", argv[i]);

        // free json value
        json_decref(value);
    }

    return errors? 3: 0;
}
#endif  // WITH_MAIN
